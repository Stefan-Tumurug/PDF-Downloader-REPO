<!--
===============================================================================
 MainWindow.xaml
===============================================================================

 PURPOSE
  - Main GUI layout for PdfDownloader.
  - Defines visual structure, layout containers, styling, and bindings.

 ARCHITECTURE ROLE
  - Pure View layer (MVVM).
  - No business logic should exist here.
  - Behavior is delegated to:
      * MainViewModel (bindings)
      * ICommand implementations
      * Observable collections

 GUIDELINES
  - Keep XAML declarative.
  - Avoid code-behind logic.
  - Prefer simple bindings and reusable Resources.

 HANDOVER NOTES
  - If behavior changes are required, extend the ViewModel.
  - Keep styling reusable via Resources.
===============================================================================
-->
<Window x:Class="PdfDownloader.Gui.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="PDF Downloader"
        Height="650"
        Width="980"
        MinWidth="860"
        MinHeight="600"
        WindowStartupLocation="CenterScreen"
        Background="#FFF6F7F9">

    <Window.Resources>

        <!-- ===== Typography ===== -->
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="#FF1F2937"/>
        </Style>

        <Style x:Key="LabelText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#FF374151"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <Style x:Key="HintText" TargetType="TextBlock">
            <Setter Property="Foreground" Value="#FF6B7280"/>
            <Setter Property="FontSize" Value="12"/>
        </Style>

        <!-- ===== TextBox ===== -->
        <Style TargetType="TextBox">
            <Setter Property="MinHeight" Value="28"/>
            <Setter Property="Padding" Value="8,4"/>
            <Setter Property="BorderBrush" Value="#FFD1D5DB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
        </Style>

        <!-- ===== CheckBox ===== -->
        <Style TargetType="CheckBox">
            <Setter Property="Foreground" Value="#FF374151"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>

        <!-- ===== Buttons ===== -->
        <Style x:Key="BaseButton" TargetType="Button">
            <Setter Property="MinHeight" Value="30"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#FFD1D5DB"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#FF111827"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>

        <Style x:Key="PrimaryButton" TargetType="Button" BasedOn="{StaticResource BaseButton}">
            <Setter Property="Background" Value="#FF2563EB"/>
            <Setter Property="BorderBrush" Value="#FF2563EB"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <Style x:Key="DangerButton" TargetType="Button" BasedOn="{StaticResource BaseButton}">
            <Setter Property="Background" Value="#FFDC2626"/>
            <Setter Property="BorderBrush" Value="#FFDC2626"/>
            <Setter Property="Foreground" Value="White"/>
        </Style>

        <Style TargetType="Button" BasedOn="{StaticResource BaseButton}">
            <Style.Triggers>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Opacity" Value="0.55"/>
                    <Setter Property="Cursor" Value="Arrow"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- ===== Card container ===== -->
        <Style x:Key="Card" TargetType="Border">
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="BorderBrush" Value="#FFE5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="14"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>

        <!-- ===== DataGrid styling ===== -->
        <Style TargetType="DataGrid">
            <Setter Property="BorderBrush" Value="#FFE5E7EB"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="RowBackground" Value="White"/>
            <Setter Property="AlternatingRowBackground" Value="#FFF9FAFB"/>
            <Setter Property="GridLinesVisibility" Value="Horizontal"/>
            <Setter Property="HorizontalGridLinesBrush" Value="#FFE5E7EB"/>
            <Setter Property="VerticalGridLinesBrush" Value="#FFE5E7EB"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
            <Setter Property="CanUserResizeRows" Value="False"/>
            <Setter Property="CanUserReorderColumns" Value="False"/>
            <Setter Property="CanUserSortColumns" Value="True"/>
        </Style>

        <Style TargetType="DataGridColumnHeader">
            <Setter Property="Background" Value="#FFF3F4F6"/>
            <Setter Property="Foreground" Value="#FF111827"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Padding" Value="10,8"/>
            <Setter Property="BorderBrush" Value="#FFE5E7EB"/>
            <Setter Property="BorderThickness" Value="0,0,0,1"/>
        </Style>

        <Style TargetType="DataGridCell">
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="BorderThickness" Value="0"/>
        </Style>

    </Window.Resources>

    <Grid Margin="14">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <!-- header -->
            <RowDefinition Height="Auto"/>
            <!-- inputs -->
            <RowDefinition Height="Auto"/>
            <!-- actions + progress -->
            <RowDefinition Height="2*"/>
            <!-- selection -->
            <RowDefinition Height="*"/>
            <!-- results -->
        </Grid.RowDefinitions>

        <!-- =========================
             Header
             ========================= -->
        <Border Grid.Row="0" Style="{StaticResource Card}" Margin="0,0,0,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="PDF Downloader"
                               FontSize="18"
                               FontWeight="SemiBold"/>

                    <TextBlock Text="Select an Excel file and an output folder. The run stops after the configured number of successful downloads."
                               Margin="0,6,0,0"
                               Style="{StaticResource HintText}"
                               TextWrapping="Wrap"/>
                </StackPanel>

                <TextBlock Grid.Column="1"
                           Text="{Binding Vm.StatusText}"
                           VerticalAlignment="Center"
                           Margin="16,0,0,0"
                           FontWeight="SemiBold"
                           Foreground="#FF2563EB"/>
            </Grid>
        </Border>

        <!-- =========================
             Inputs
             ========================= -->
        <Border Grid.Row="1" Style="{StaticResource Card}" Margin="0,0,0,12">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="120"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="110"/>
                </Grid.ColumnDefinitions>

                <!-- Excel -->
                <TextBlock Grid.Row="0" Grid.Column="0"
                           Text="Excel file"
                           Style="{StaticResource LabelText}"
                           Margin="0,0,10,10"/>

                <TextBox Grid.Row="0" Grid.Column="1"
                         Text="{Binding Vm.XlsxPath, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,10,10"/>

                <Button Grid.Row="0" Grid.Column="2"
                        Content="Browse..."
                        Command="{Binding BrowseExcelCommand}"
                        Margin="0,0,0,10"/>

                <!-- Output -->
                <TextBlock Grid.Row="1" Grid.Column="0"
                           Text="Output folder"
                           Style="{StaticResource LabelText}"
                           Margin="0,0,10,10"/>

                <TextBox Grid.Row="1" Grid.Column="1"
                         Text="{Binding Vm.OutputFolder, UpdateSourceTrigger=PropertyChanged}"
                         Margin="0,0,10,10"/>

                <Button Grid.Row="1" Grid.Column="2"
                        Content="Browse..."
                        Command="{Binding BrowseOutputCommand}"
                        Margin="0,0,0,10"/>

                <!-- Options -->
                <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3"
                            Orientation="Horizontal"
                            Margin="0,2,0,0">

                    <TextBlock Text="Download limit:"
                               Style="{StaticResource LabelText}"
                               Margin="0,0,8,0"/>

                    <TextBox Width="80"
                             Text="{Binding Vm.MaxSuccessfulDownloads, UpdateSourceTrigger=PropertyChanged}"/>

                    <TextBlock Text="Preview rows:"
                               Style="{StaticResource LabelText}"
                               Margin="16,0,8,0"/>

                    <TextBox Width="70"
                             Text="{Binding Vm.PreviewStartText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="Start row (1-based)"/>

                    <TextBlock Text="to"
                               Style="{StaticResource LabelText}"
                               Margin="8,0,8,0"/>

                    <TextBox Width="70"
                             Text="{Binding Vm.PreviewEndText, UpdateSourceTrigger=PropertyChanged}"
                             ToolTip="End row (1-based)"/>

                    <Button Content="Reload"
                            Margin="12,0,0,0"
                            Command="{Binding LoadCommand}"/>

                    <CheckBox Content="Overwrite existing files"
                              Margin="16,0,0,0"
                              IsChecked="{Binding Vm.OverwriteExisting}"/>

                    <TextBlock Text="Tip: Load uses the range above."
                               Style="{StaticResource HintText}"
                               Margin="16,0,0,0"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- =========================
             Actions + Progress
             ========================= -->
        <Grid Grid.Row="2" Margin="0,0,0,12">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Actions + summary -->
            <Border Grid.Column="0" Style="{StaticResource Card}" Padding="14" Margin="0,0,12,0">
                <StackPanel>
                    <StackPanel Orientation="Horizontal">
                        <Button Style="{StaticResource PrimaryButton}"
                                Content="Start"
                                Width="120"
                                Margin="0,0,8,0"
                                Command="{Binding StartCommand}"
                                IsEnabled="{Binding Vm.CanStart}"/>

                        <Button Style="{StaticResource DangerButton}"
                                Content="Cancel"
                                Width="120"
                                Command="{Binding CancelCommand}"
                                IsEnabled="{Binding Vm.CanCancel}"/>
                    </StackPanel>

                    <!-- Summary counters -->
                    <StackPanel Orientation="Horizontal" Margin="0,12,0,0">
                        <TextBlock Margin="0,0,12,0">
                            <Run Text="Downloaded: "/>
                            <Run Text="{Binding Vm.DownloadedCount, Mode=OneWay}"/>
                        </TextBlock>

                        <TextBlock Margin="0,0,12,0">
                            <Run Text="Failed: "/>
                            <Run Text="{Binding Vm.FailedCount, Mode=OneWay}"/>
                        </TextBlock>

                        <TextBlock>
                            <Run Text="Skipped: "/>
                            <Run Text="{Binding Vm.SkippedCount, Mode=OneWay}"/>
                        </TextBlock>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Progress -->
            <Border Grid.Column="1" Style="{StaticResource Card}">
                <StackPanel>
                    <TextBlock Text="Progress"
                               FontWeight="SemiBold"
                               Margin="0,0,0,8"/>

                    <ProgressBar Height="16"
                                 Minimum="0"
                                 Maximum="100"
                                 Value="{Binding Vm.ProgressPercent, Mode=OneWay}" />

                    <TextBlock Margin="0,10,0,0"
                               Text="{Binding Vm.ProgressText}"
                               Style="{StaticResource HintText}"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- =========================
             Records to download grid
             ========================= -->
        <Border Grid.Row="3" Style="{StaticResource Card}" Margin="0,0,0,12" MinHeight="220">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header -->
                <Grid Grid.Row="0" Margin="0,0,0,10">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Vertical">
                        <TextBlock Text="Selection"
                                   FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>

                        <TextBlock FontSize="12"
                                   Opacity="0.75"
                                   Text="{Binding Vm.Records.Count, StringFormat=Rows loaded: {0}}"/>
                    </StackPanel>

                    <Button Grid.Column="1"
                            Content="Select all"
                            Margin="10,0,0,0"
                            Command="{Binding SelectAllCommand}"/>

                    <Button Grid.Column="2"
                            Content="Clear"
                            Margin="10,0,0,0"
                            Command="{Binding ClearSelectionCommand}"/>
                </Grid>

                <!-- DataGrid -->
                <Grid Grid.Row="1">

                    <!-- Empty state overlay -->
                    <TextBlock Text="No rows loaded. Click Reload to load the selected range."
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"
                               Opacity="0.6">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Vm.Records.Count}" Value="0">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>

                    <DataGrid ItemsSource="{Binding Vm.Records}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              CanUserDeleteRows="False"
                              CanUserReorderColumns="False"
                              CanUserResizeRows="False"
                              IsReadOnly="False"
                              SelectionUnit="FullRow"
                              SelectionMode="Extended"
                              IsSynchronizedWithCurrentItem="False"
                              EnableRowVirtualization="True"
                              EnableColumnVirtualization="True"
                              VirtualizingPanel.IsVirtualizing="True"
                              VirtualizingPanel.VirtualizationMode="Recycling"
                              ScrollViewer.CanContentScroll="True"
                              ScrollViewer.VerticalScrollBarVisibility="Auto"
                              ScrollViewer.HorizontalScrollBarVisibility="Auto"
                              ScrollViewer.IsDeferredScrollingEnabled="True"
                              RowHeight="30"
                              HeadersVisibility="Column"
                              GridLinesVisibility="Horizontal">

                        <DataGrid.Resources>
                            <!-- Wrap lange URL'er pænt -->
                            <Style TargetType="TextBlock">
                                <Setter Property="TextWrapping" Value="Wrap"/>
                                <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
                                <Setter Property="VerticalAlignment" Value="Center"/>
                            </Style>
                        </DataGrid.Resources>

                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="Sel."
                                                    Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                    Width="60"/>

                            <DataGridTextColumn Header="BR"
                                                Binding="{Binding BrNum}"
                                                Width="120"
                                                IsReadOnly="True"/>

                            <DataGridTemplateColumn Header="Primary URL" Width="*"
                                                    IsReadOnly="True">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding PrimaryUrl}"
                                                   ToolTip="{Binding PrimaryUrl}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTemplateColumn Header="Fallback URL" Width="*"
                                                    IsReadOnly="True">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding FallbackUrl}"
                                                   ToolTip="{Binding FallbackUrl}"/>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>
                        </DataGrid.Columns>
                    </DataGrid>
                </Grid>
            </Grid>
        </Border>

        <!-- =========================
             Results grid
             ========================= -->
        <Border Grid.Row="4" Style="{StaticResource Card}" Padding="0">
            <DataGrid ItemsSource="{Binding Vm.Rows}"
                      AutoGenerateColumns="False"
                      IsReadOnly="True"
                      CanUserAddRows="False">
                <DataGrid.Columns>
                    <DataGridTextColumn Header="BR"
                                        Binding="{Binding BrNum}"
                                        Width="120"/>

                    <DataGridTextColumn Header="Attempted URL"
                                        Binding="{Binding AttemptedUrl}"
                                        Width="*"/>

                    <DataGridTextColumn Header="Status"
                                        Binding="{Binding Status}"
                                        Width="140"/>

                    <DataGridTextColumn Header="Error"
                                        Binding="{Binding Error}"
                                        Width="260"/>
                </DataGrid.Columns>
            </DataGrid>
        </Border>
    </Grid>
</Window>
